// *** Deselvolvido por Alessandro Drese

input
Periodo(5);

var
  topos       : array[0..1] of float;
  fundos      : array[0..1] of float;
  suporte     : float;
  resistencia : float;
  barTP       : integer;
  TP          : boolean;
  vWap        : float;
  volAcum     : float;
  volAcumP    : float;
  n           : integer;
  
begin
  // Verificar candidatos a topos e fundos
  if(TP) and (high[Periodo] = highest(high, Periodo*2)[1]) then
    begin
      topos[1] :=topos[0];
      topos[0] := high[Periodo];
      barTP := currentBar - Periodo;
      TP := false;
    end;
  if(TP=false) and (low[Periodo] = lowest(low, Periodo*2)[1]) then
    begin
      fundos[1] :=fundos[0];
      fundos[0] :=low[Periodo]; 
      barTP := currentBar - Periodo;
      TP := true;
    end; 
  
  suporte := fundos;
  resistencia := topos;


  // CÃ¡lculo VWAP
  volAcum := 0;
  volAcumP := 0;
  n := currentbar - barTP;        
  while(n > 0) do
    begin 
      volAcum := volAcum + Volume[n];
      volAcumP := volAcumP + Minima[n] * Volume[n];       
      n:= n-1;
      vWap:=volAcumP / volAcum;
    end;     


  // Saidas do indicador
  Plot(suporte);
  Plot2(resistencia);
  Plot3(vWap);
  
  Setplotcolor(1, clGreen);
  Setplotcolor(2, clRed);
  Setplotcolor(3, clYellow);

  SetPlotStyle(3, 1);

  SetPlotWidth(1, 2);
  SetPlotWidth(2, 2);
  SetPlotWidth(3, 2);
end;